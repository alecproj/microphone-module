<div align="center">

# Обнаружение голосовой активности
[English](./README.md) | Русский
</div>

Этот пример используется для тестирования детекции голосовой активности (Voice Activity Detection, VAD). Поддерживаются два типа VAD: WebRTC VAD и vadnet1 от Espressif. Вы можете выбрать необходимую версию через menuconfig. По сравнению с WebRTC VAD, vadnet1 лучше фильтрует фоновые шумы, однако требует больше ресурсов CPU.

# Быстрый старт

## Подготовка оборудования

Для запуска этого примера вам понадобится плата разработки **ESP32** или **ESP32-S3** (рекомендуется ESP32-S3) с одним или двумя микрофонами **INMP441** (или другими I²S MEMS-микрофонами).

## Подготовка ПО

### Модуль микрофона

Клонируйте этот проект следующей командой:
```sh
git clone https://github.com/alecproj/microphone-module.git
```
Перейдите в директорию примера:
```sh
cd microphone-module/examples/voice_activity_detection
```
### ESP-IDF

Поддерживаются версии [ESP-IDF v5.0](https://github.com/espressif/esp-idf/tree/release/v5.0) или новее. Если вы уже настроили ESP-IDF и не хотите менять существующую конфигурацию, можете указать путь к ESP-IDF через переменную окружения `IDF_PATH`.

> [!NOTE]  
> Для подробностей по установке ESP-IDF см. [документацию ESP-IDF](https://docs.espressif.com/projects/esp-idf/en/v5.4.2/esp32s3/get-started/index.html)

### Конфигурирование

Выберите плату и модель VAD:
```
idf.py set-target esp32s3
idf.py menuconfig

# Выберите аудиоплату
Audio Media HAL -> Audio hardware board -> ESP32-S3-1mic

# Загрузите модель vadnet1
ESP Speech Recognition -> Select voice activity detection -> voice activity detection (vadnet1 medium)
```
### Параметры

В файле конфигурации можно задать следующие параметры:

```c
    vad_init;           // Инициализация VAD
    vad_mode;           // Может принимать значения: VAD_MODE_0, VAD_MODE_1, VAD_MODE_2, VAD_MODE_3, VAD_MODE_4
                        // Чем выше режим, тем выше вероятность срабатывания на речь.

    vad_model_name;     // Имя модели VAD. Если null, используется WebRTC VAD.
    vad_min_speech_ms;  // Минимальная длительность речи в мс. Должна быть больше 32 мс, по умолчанию: 128 мс
    vad_min_noise_ms;   // Минимальная длительность шума или тишины в мс. Должна быть больше 64 мс, по умолчанию: 1000 мс
    vad_delay_ms;       // Задержка до первого фрейма речи в мс, по умолчанию: 128 мс
                        // Если VAD-кеш не покрывает весь фрагмент речи, увеличьте это значение.
```

В настройках VAD есть два фактора, которые могут вызвать задержку срабатывания на первый фрейм речи:
1. Встроенная задержка самого алгоритма VAD. Алгоритм может определить начало речи с задержкой в 1–3 кадра.
2. Во избежание ложных срабатываний VAD срабатывает только при достижении непрерывной длительности речи, указанной в параметре `vad_min_speech_ms`.

Из-за этих причин прямое использование первого фрейма VAD может привести к усечению первого слова. Чтобы этого избежать, в AFE V2.0 добавлен VAD-кеш. Вы можете определить необходимость сохранения кеша по значению `vad_cache_size`.
### Сборка и прошивка

Соберите проект и прошейте плату, затем запустите монитор для просмотра вывода по последовательному порту:
```sh
idf.py flash monitor
```
(Для выхода из монитора нажмите `Ctrl-]`.)